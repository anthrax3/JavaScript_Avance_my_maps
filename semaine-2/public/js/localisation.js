var Localisation;

Localisation = (function() {
  var getMarker, loadMarkers, removeMarker, showUserLocation, updateMarker;

  Localisation.map = '';

  Localisation.markers = {};

  Localisation.myMarker = {};

  Localisation.chat = {};

  function Localisation(socket, chat, mapId) {
    var defaultPosition, mapOptions;
    this.socket = socket;
    defaultPosition = new google.maps.LatLng(-34.397, 150.644);
    mapOptions = {
      zoom: 8,
      panControl: false,
      zoomControlOptions: {
        style: google.maps.ZoomControlStyle.LARGE,
        position: google.maps.ControlPosition.LEFT_CENTER
      },
      center: defaultPosition,
      mapTypeId: google.maps.MapTypeId.ROADMAP
    };
    Localisation.map = new google.maps.Map(document.getElementById(mapId), mapOptions);
    Localisation.markers = {
      1: 1
    };
    Localisation.chat = chat;
    this.geolocation(this.showPosition);
    socket.on('updateLocation', updateMarker);
    socket.on('logout', removeMarker);
    socket.emit('requestLocations', loadMarkers);
  }

  Localisation.prototype.geolocation = function(successHandler, errorHandler) {
    errorHandler = errorHandler || this.geolocationErrorHandler;
    if (navigator.geolocation) {
      return navigator.geolocation.getCurrentPosition(successHandler, errorHandler);
    } else {
      return alert("La géolocalisation n'est pas supporté par ce navigateur.");
    }
  };

  Localisation.prototype.showPosition = function(position) {
    var data;
    data = {
      lat: position.coords.latitude,
      lng: position.coords.longitude
    };
    Localisation.myMarker = getMarker(data.lat, data.lng, 'Me');
    Localisation.map.setCenter(Localisation.myMarker.getPosition());
    return socket.emit("sendLocation", data);
  };

  Localisation.prototype.geolocationErrorHandler = function(error) {
    switch (error.code) {
      case error.PERMISSION_DENIED:
        return alert("Votre position ne sera pas partagée avec d'autres utilisateurs.");
      case error.POSITION_UNAVAILABLE:
        return alert("Les informations de geolocalisation sont indisponible.");
      case error.TIMEOUT:
        return alert("La demande pour obtenir votre position à expiré.");
      case error.UNKNOWN_ERROR:
        return alert("Une erreur inconnue est survenue.");
    }
  };

  getMarker = function(lat, lng, title) {
    return new google.maps.Marker({
      title: title,
      map: Localisation.map,
      position: new google.maps.LatLng(lat, lng)
    });
  };

  updateMarker = function(data) {
    var marker;
    marker = Localisation.markers[data.id];
    if (marker) {
      marker.setPosition(new google.maps.LatLng(data.lat, data.lng));
    } else {
      Localisation.markers[data.id] = getMarker(data.lat, data.lng, data.username);
    }
    console.log(Localisation.markers, "updateMarker");
    $('.sender').click(showUserLocation);
  };

  loadMarkers = function(data) {
    var key, user;
    for (key in data) {
      user = data[key];
      Localisation.markers[key] = getMarker(user.lat, user.lng, user.username);
    }
    console.log(Localisation.markers, "loadMarkers");
    $('.sender').click(showUserLocation);
  };

  removeMarker = function(user) {
    var marker;
    marker = Localisation.markers[user.id];
    if (marker) {
      marker.setMap(null);
      delete Localisation.markers[user.id];
    }
    console.log(user, Localisation.markers, "removeMarker");
  };

  showUserLocation = function(event) {
    var key, userMarker, username;
    event.preventDefault();
    console.log('showUserLocation');
    key = $(this).data("id");
    username = $(this).data("user");
    console.log(key, username, Localisation.chat.user.name);
    if (username === Localisation.chat.user.name) {
      Localisation.map.setCenter(Localisation.myMarker.getPosition());
    } else {
      userMarker = Localisation.markers[key];
      if (userMarker) {
        Localisation.map.setCenter(userMarker.getPosition());
      } else {
        alert("L'utilisateur n'est plus connecté.");
      }
    }
  };

  return Localisation;

})();

//# sourceMappingURL=data:application/json;base64,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O0FBR0ksUUFBQSxLQUFBLENBQU0sb0NBQU4sQ0FBQSxDQUhKO09BSko7S0FOZTtFQUFBLENBL0ZuQixDQUFBOztzQkFBQTs7SUFESixDQUFBIiwiZmlsZSI6ImxvY2FsaXNhdGlvbi5qcyIsInNvdXJjZVJvb3QiOiIvc291cmNlLyIsInNvdXJjZXNDb250ZW50IjpbImNsYXNzIExvY2FsaXNhdGlvblxuICAgIExvY2FsaXNhdGlvbi5tYXAgPSAnJ1xuICAgIExvY2FsaXNhdGlvbi5tYXJrZXJzID0ge31cbiAgICBMb2NhbGlzYXRpb24ubXlNYXJrZXIgPSB7fVxuICAgIExvY2FsaXNhdGlvbi5jaGF0ID0ge31cbiAgICBjb25zdHJ1Y3RvcjogKEBzb2NrZXQsIGNoYXQsIG1hcElkKSAtPlxuXG4gICAgICAgIGRlZmF1bHRQb3NpdGlvbiA9IG5ldyBnb29nbGUubWFwcy5MYXRMbmcoLTM0LjM5NywgMTUwLjY0NClcbiAgICAgICAgbWFwT3B0aW9ucyA9XG4gICAgICAgICAgICB6b29tOiA4XG4gICAgICAgICAgICBwYW5Db250cm9sOiBmYWxzZVxuICAgICAgICAgICAgem9vbUNvbnRyb2xPcHRpb25zOiB7XG4gICAgICAgICAgICAgICAgc3R5bGU6IGdvb2dsZS5tYXBzLlpvb21Db250cm9sU3R5bGUuTEFSR0UsXG4gICAgICAgICAgICAgICAgcG9zaXRpb246IGdvb2dsZS5tYXBzLkNvbnRyb2xQb3NpdGlvbi5MRUZUX0NFTlRFUlxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY2VudGVyOiBkZWZhdWx0UG9zaXRpb25cbiAgICAgICAgICAgIG1hcFR5cGVJZDogZ29vZ2xlLm1hcHMuTWFwVHlwZUlkLlJPQURNQVBcblxuICAgICAgICBMb2NhbGlzYXRpb24ubWFwID0gbmV3IGdvb2dsZS5tYXBzLk1hcChkb2N1bWVudC5nZXRFbGVtZW50QnlJZChtYXBJZCksIG1hcE9wdGlvbnMpXG4gICAgICAgIExvY2FsaXNhdGlvbi5tYXJrZXJzID0gezF9XG4gICAgICAgIExvY2FsaXNhdGlvbi5jaGF0ID0gY2hhdFxuICAgICAgICBAZ2VvbG9jYXRpb24oQHNob3dQb3NpdGlvbilcblxuICAgICAgICBzb2NrZXQub24gJ3VwZGF0ZUxvY2F0aW9uJywgdXBkYXRlTWFya2VyXG4gICAgICAgIHNvY2tldC5vbiAnbG9nb3V0JywgcmVtb3ZlTWFya2VyXG4gICAgICAgIHNvY2tldC5lbWl0ICdyZXF1ZXN0TG9jYXRpb25zJywgbG9hZE1hcmtlcnNcblxuICAgICMgVsOpcmlmaWUgc2kgbGEgZ2VvbG9jYWxpc2F0aW9uIGVzdCBwb3NzaWJsZVxuICAgIGdlb2xvY2F0aW9uOiAoc3VjY2Vzc0hhbmRsZXIsIGVycm9ySGFuZGxlcikgLT5cbiAgICAgICAgZXJyb3JIYW5kbGVyID0gZXJyb3JIYW5kbGVyIHx8IEBnZW9sb2NhdGlvbkVycm9ySGFuZGxlclxuXG4gICAgICAgIGlmKG5hdmlnYXRvci5nZW9sb2NhdGlvbilcbiAgICAgICAgICAgIG5hdmlnYXRvci5nZW9sb2NhdGlvbi5nZXRDdXJyZW50UG9zaXRpb24oc3VjY2Vzc0hhbmRsZXIsIGVycm9ySGFuZGxlcilcbiAgICAgICAgZWxzZVxuICAgICAgICAgICAgYWxlcnQoXCJMYSBnw6lvbG9jYWxpc2F0aW9uIG4nZXN0IHBhcyBzdXBwb3J0w6kgcGFyIGNlIG5hdmlnYXRldXIuXCIpXG5cbiAgICAjIGVudm9pIGxhIGdlb2xvY2FsaXNhdGlvbiBhdSBzZXJ2ZXJcbiAgICBzaG93UG9zaXRpb246IChwb3NpdGlvbikgLT5cbiAgICAgICAgZGF0YSA9XG4gICAgICAgICAgICBsYXQgOiBwb3NpdGlvbi5jb29yZHMubGF0aXR1ZGVcbiAgICAgICAgICAgIGxuZyA6IHBvc2l0aW9uLmNvb3Jkcy5sb25naXR1ZGVcblxuICAgICAgICBMb2NhbGlzYXRpb24ubXlNYXJrZXIgPSBnZXRNYXJrZXIoZGF0YS5sYXQsIGRhdGEubG5nLCAnTWUnKVxuICAgICAgICBMb2NhbGlzYXRpb24ubWFwLnNldENlbnRlcihMb2NhbGlzYXRpb24ubXlNYXJrZXIuZ2V0UG9zaXRpb24oKSlcbiAgICAgICAgc29ja2V0LmVtaXQoXCJzZW5kTG9jYXRpb25cIiwgZGF0YSlcblxuICAgICMgRMOpZmluaSBsJ2VycmV1ciBkZSBnZW9sb2NhbGlzYXRpb25cbiAgICBnZW9sb2NhdGlvbkVycm9ySGFuZGxlcjogKGVycm9yKSAtPlxuICAgICAgICBzd2l0Y2ggZXJyb3IuY29kZVxuICAgICAgICAgICAgd2hlbiBlcnJvci5QRVJNSVNTSU9OX0RFTklFRFxuICAgICAgICAgICAgICAgIGFsZXJ0IFwiVm90cmUgcG9zaXRpb24gbmUgc2VyYSBwYXMgcGFydGFnw6llIGF2ZWMgZCdhdXRyZXMgdXRpbGlzYXRldXJzLlwiXG4gICAgICAgICAgICB3aGVuIGVycm9yLlBPU0lUSU9OX1VOQVZBSUxBQkxFXG4gICAgICAgICAgICAgICAgYWxlcnQgXCJMZXMgaW5mb3JtYXRpb25zIGRlIGdlb2xvY2FsaXNhdGlvbiBzb250IGluZGlzcG9uaWJsZS5cIlxuICAgICAgICAgICAgd2hlbiBlcnJvci5USU1FT1VUXG4gICAgICAgICAgICAgICAgYWxlcnQgXCJMYSBkZW1hbmRlIHBvdXIgb2J0ZW5pciB2b3RyZSBwb3NpdGlvbiDDoCBleHBpcsOpLlwiXG4gICAgICAgICAgICB3aGVuIGVycm9yLlVOS05PV05fRVJST1JcbiAgICAgICAgICAgICAgICBhbGVydCBcIlVuZSBlcnJldXIgaW5jb25udWUgZXN0IHN1cnZlbnVlLlwiXG5cbiAgICAjIFBsYWNlIHVuIG1hcmtlciBzdXIgbGEgbWFwXG4gICAgZ2V0TWFya2VyID0gKGxhdCwgbG5nLCB0aXRsZSkgLT5cbiAgICAgICAgbmV3IGdvb2dsZS5tYXBzLk1hcmtlcihcbiAgICAgICAgICAgIHRpdGxlOiB0aXRsZVxuICAgICAgICAgICAgbWFwOiBMb2NhbGlzYXRpb24ubWFwXG4gICAgICAgICAgICBwb3NpdGlvbjogbmV3IGdvb2dsZS5tYXBzLkxhdExuZyhsYXQsIGxuZylcbiAgICAgICAgKVxuXG4gICAgIyBNZXQgYSBqb3VyIGxhIHBvc2l0aW9uIGQndW4gbWFya2VyIHN1ciBsYSBtYXBcbiAgICB1cGRhdGVNYXJrZXIgPSAoZGF0YSkgLT5cbiAgICAgICAgbWFya2VyID0gTG9jYWxpc2F0aW9uLm1hcmtlcnNbZGF0YS5pZF1cbiAgICAgICAgaWYgbWFya2VyXG4gICAgICAgICAgICBtYXJrZXIuc2V0UG9zaXRpb24gbmV3IGdvb2dsZS5tYXBzLkxhdExuZyhkYXRhLmxhdCwgZGF0YS5sbmcpXG4gICAgICAgIGVsc2VcbiAgICAgICAgICAgIExvY2FsaXNhdGlvbi5tYXJrZXJzW2RhdGEuaWRdID0gZ2V0TWFya2VyKGRhdGEubGF0LCBkYXRhLmxuZywgZGF0YS51c2VybmFtZSlcbiAgICAgICAgY29uc29sZS5sb2cgTG9jYWxpc2F0aW9uLm1hcmtlcnMsIFwidXBkYXRlTWFya2VyXCJcbiAgICAgICAgJCgnLnNlbmRlcicpLmNsaWNrIHNob3dVc2VyTG9jYXRpb25cbiAgICAgICAgcmV0dXJuXG5cbiAgICAjIGNoYXJnZSB1biBub3V2ZWF1IG1hcmtlciBzdXIgbGEgbWFwXG4gICAgbG9hZE1hcmtlcnMgPSAoZGF0YSkgLT5cbiAgICAgICAgZm9yIGtleSBvZiBkYXRhXG4gICAgICAgICAgICB1c2VyID0gZGF0YVtrZXldXG4gICAgICAgICAgICBMb2NhbGlzYXRpb24ubWFya2Vyc1trZXldID0gZ2V0TWFya2VyKHVzZXIubGF0LCB1c2VyLmxuZywgdXNlci51c2VybmFtZSlcbiAgICAgICAgY29uc29sZS5sb2cgTG9jYWxpc2F0aW9uLm1hcmtlcnMsIFwibG9hZE1hcmtlcnNcIlxuICAgICAgICAkKCcuc2VuZGVyJykuY2xpY2sgc2hvd1VzZXJMb2NhdGlvblxuICAgICAgICByZXR1cm5cblxuICAgICMgc3VwcHJpbWUgdW4gbWFya2VyIHN1ciBsYSBtYXBcbiAgICByZW1vdmVNYXJrZXIgPSAodXNlcikgLT5cbiAgICAgICAgbWFya2VyID0gTG9jYWxpc2F0aW9uLm1hcmtlcnNbdXNlci5pZF1cbiAgICAgICAgaWYgbWFya2VyXG4gICAgICAgICAgICBtYXJrZXIuc2V0TWFwIG51bGxcbiAgICAgICAgICAgIGRlbGV0ZSBMb2NhbGlzYXRpb24ubWFya2Vyc1t1c2VyLmlkXVxuICAgICAgICBjb25zb2xlLmxvZyB1c2VyLCBMb2NhbGlzYXRpb24ubWFya2VycywgXCJyZW1vdmVNYXJrZXJcIlxuICAgICAgICByZXR1cm5cblxuICAgICMgY2VudHJlIGxhIG1hcCBzdXIgbGEgcG9zaXRpb24gZCd1biB1dGlsaXNhdGV1clxuICAgIHNob3dVc2VyTG9jYXRpb24gPSAoZXZlbnQpIC0+XG4gICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KClcbiAgICAgICAgY29uc29sZS5sb2cgJ3Nob3dVc2VyTG9jYXRpb24nXG4gICAgICAgIGtleSA9ICQodGhpcykuZGF0YShcImlkXCIpXG4gICAgICAgIHVzZXJuYW1lID0gJCh0aGlzKS5kYXRhKFwidXNlclwiKVxuICAgICAgICBjb25zb2xlLmxvZyBrZXksIHVzZXJuYW1lLCBMb2NhbGlzYXRpb24uY2hhdC51c2VyLm5hbWVcbiAgICAgICAgaWYgdXNlcm5hbWUgaXMgTG9jYWxpc2F0aW9uLmNoYXQudXNlci5uYW1lXG4gICAgICAgICAgICBMb2NhbGlzYXRpb24ubWFwLnNldENlbnRlciBMb2NhbGlzYXRpb24ubXlNYXJrZXIuZ2V0UG9zaXRpb24oKVxuICAgICAgICBlbHNlXG4gICAgICAgICAgICB1c2VyTWFya2VyID0gTG9jYWxpc2F0aW9uLm1hcmtlcnNba2V5XVxuICAgICAgICAgICAgaWYgdXNlck1hcmtlclxuICAgICAgICAgICAgICAgIExvY2FsaXNhdGlvbi5tYXAuc2V0Q2VudGVyIHVzZXJNYXJrZXIuZ2V0UG9zaXRpb24oKVxuICAgICAgICAgICAgZWxzZVxuICAgICAgICAgICAgICAgIGFsZXJ0IFwiTCd1dGlsaXNhdGV1ciBuJ2VzdCBwbHVzIGNvbm5lY3TDqS5cIlxuICAgICAgICByZXR1cm5cbiJdfQ==